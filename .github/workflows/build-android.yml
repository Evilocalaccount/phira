# Fixed GitHub Actions workflow for building Phira Android APK
# Targets the specific workspace member instead of virtual manifest

name: Build Phira Android APK (Fixed)

on:
  workflow_dispatch:
    inputs:
      features:
        description: 'Features to enable'
        required: false
        default: 'chat'
        type: choice
        options:
          - chat
          - chat,video
          - chat,video,aa
          - chat,video,aa,event_debug
      build_mode:
        description: 'Build mode'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug
      package_name:
        description: 'Workspace member to build (usually phira-main)'
        required: false
        default: 'phira-main'
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: TeamFlos/phira
          ref: main
          
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android
          
      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Setup Android environment
        run: |
          echo "Setting up Android environment..."
          
          # Install Android SDK
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mkdir -p android-sdk/cmdline-tools
          mv cmdline-tools android-sdk/cmdline-tools/latest
          
          export ANDROID_HOME=$PWD/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          
          # Install SDK components
          yes | sdkmanager --licenses
          sdkmanager "platforms;android-33" "build-tools;33.0.0" "ndk;25.2.9519653"
          
          # Set environment variables
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV
          
      - name: Install cargo-apk
        run: |
          echo "Installing cargo-apk..."
          cargo install cargo-apk --force
          
      - name: Check project structure and identify Android target
        id: project_check
        run: |
          echo "Checking project structure..."
          echo "Current directory: $(pwd)"
          
          echo "=== Workspace members ==="
          cat Cargo.toml | grep -A 20 "members"
          
          echo "=== Checking specified package: ${{ github.event.inputs.package_name }} ==="
          if [ -d "${{ github.event.inputs.package_name }}" ] && [ -f "${{ github.event.inputs.package_name }}/Cargo.toml" ]; then
            echo "Package exists: ${{ github.event.inputs.package_name }}"
            
            echo "=== Package manifest ==="
            cat ${{ github.event.inputs.package_name }}/Cargo.toml
            
            # Check for Android metadata
            if grep -q "package.metadata.android" "${{ github.event.inputs.package_name }}/Cargo.toml"; then
              echo "Android metadata found in package manifest"
              echo "android_ready=true" >> $GITHUB_OUTPUT
            else
              echo "No Android metadata found - will need to add it"
              echo "android_ready=false" >> $GITHUB_OUTPUT
            fi
            
            # Get package name from Cargo.toml
            PKG_NAME=$(grep '^name' "${{ github.event.inputs.package_name }}/Cargo.toml" | head -1 | cut -d'"' -f2)
            echo "package_name=$PKG_NAME" >> $GITHUB_OUTPUT
            echo "Detected package name: $PKG_NAME"
          else
            echo "Package ${{ github.event.inputs.package_name }} not found!"
            echo "Available packages:"
            ls -d */ | grep -E "(phira|main|android)" || ls -d */
            echo "package_name=unknown" >> $GITHUB_OUTPUT
            echo "android_ready=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Add Android metadata if missing
        if: steps.project_check.outputs.android_ready == 'false' && steps.project_check.outputs.package_name != 'unknown'
        run: |
          echo "Adding Android metadata to package manifest..."
          cd "${{ github.event.inputs.package_name }}"
          
          # Backup original
          cp Cargo.toml Cargo.toml.backup
          
          # Add Android metadata section
          cat >> Cargo.toml << 'EOF'
          
          [package.metadata.android]
          package_name = "com.phira.game"
          version_code = 1
          version_name = "0.6.7"
          
          [package.metadata.android.sdk]
          min_sdk_version = 21
          target_sdk_version = 33
          
          [package.metadata.android.activity]
          orientation = "landscape"
          config_changes = "orientation|keyboardHidden|screenSize"
          
          [[package.metadata.android.permission]]
          name = "android.permission.INTERNET"
          
          [[package.metadata.android.permission]]
          name = "android.permission.ACCESS_NETWORK_STATE"
          
          [lib]
          crate-type = ["cdylib"]
          EOF
          
          echo "Updated manifest:"
          cat Cargo.toml
          
      - name: Configure cargo for Android
        run: |
          echo "Configuring cargo for Android..."
          mkdir -p .cargo
          
          cat > .cargo/config.toml << 'EOF'
          [build]
          target = "aarch64-linux-android"
          
          [target.aarch64-linux-android]
          ar = "${ANDROID_NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "${ANDROID_NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          
          [unstable]
          build-std = true
          EOF
          
          echo "Cargo config created:"
          cat .cargo/config.toml
          
      - name: Build APK with cargo-apk (corrected approach)
        id: build_apk
        run: |
          echo "Building APK for package: ${{ steps.project_check.outputs.package_name }}"
          echo "Features: ${{ github.event.inputs.features }}"
          echo "Build mode: ${{ github.event.inputs.build_mode }}"
          echo "Target: aarch64-linux-android"
          
          # Build the specific package with cargo-apk
          # Use -p flag to specify the package name
          if cargo apk build \
            -p "${{ steps.project_check.outputs.package_name }}" \
            --features "${{ github.event.inputs.features }}" \
            --target aarch64-linux-android \
            --${{ github.event.inputs.build_mode }}; then
            
            echo "APK build successful!"
            echo "build_success=true" >> $GITHUB_OUTPUT
            
            # Find the APK
            APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -1 || true)
            if [ -n "$APK_PATH" ]; then
              echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            fi
          else
            echo "APK build failed!"
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Build Android library as fallback
        if: steps.build_apk.outputs.build_success != 'true'
        id: build_library
        run: |
          echo "Attempting to build Android library instead..."
          
          # Build the library
          if cargo build \
            -p "${{ steps.project_check.outputs.package_name }}" \
            --features "${{ github.event.inputs.features }}" \
            --target aarch64-linux-android \
            --${{ github.event.inputs.build_mode }}; then
            
            echo "Library build successful!"
            echo "lib_success=true" >> $GITHUB_OUTPUT
            
            # Find the library
            LIB_PATH=$(find target/aarch64-linux-android -name "*.so" -type f 2>/dev/null | head -1 || true)
            if [ -n "$LIB_PATH" ]; then
              echo "lib_path=$LIB_PATH" >> $GITHUB_OUTPUT
            fi
          else
            echo "Library build also failed"
            echo "lib_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Prepare build artifacts
        run: |
          mkdir -p output
          
          if [ "${{ steps.build_apk.outputs.build_success }}" = "true" ]; then
            echo "=== Copying APK ==="
            APK_PATH="${{ steps.build_apk.outputs.apk_path }}"
            if [ -f "$APK_PATH" ]; then
              cp "$APK_PATH" output/phira-android.apk
              echo "APK copied to output/"
            else
              # Try to find APK in standard location
              find . -name "*.apk" -type f -exec cp {} output/ \; 2>/dev/null || true
            fi
            
            BUILD_TYPE="APK"
            
          elif [ "${{ steps.build_library.outputs.lib_success }}" = "true" ]; then
            echo "=== Copying library ==="
            LIB_PATH="${{ steps.build_library.outputs.lib_path }}"
            if [ -f "$LIB_PATH" ]; then
              cp "$LIB_PATH" output/libphira.so
              echo "Library copied to output/"
            else
              # Find all .so files
              find target -name "*.so" -type f -exec cp {} output/ \; 2>/dev/null || true
            fi
            
            BUILD_TYPE="LIBRARY"
            
          else
            echo "=== Build failed ==="
            BUILD_TYPE="FAILED"
          fi
          
          # Create build info
          cat > output/build-info.txt << EOF
          Phira Android Build Report
          ==========================
          
          Build Date: $(date)
          Package: ${{ steps.project_check.outputs.package_name }}
          Features: ${{ github.event.inputs.features }}
          Build Mode: ${{ github.event.inputs.build_mode }}
          Target: aarch64-linux-android
          
          Build Status: $BUILD_TYPE
          
          ${{ steps.build_apk.outputs.build_success == 'true' && 'âœ… APK Build: SUCCESS' || format('âŒ APK Build: FAILED ({0})', steps.build_library.outputs.lib_success == 'true' && 'Library only' || 'Complete failure') }}
          
          Workspace Structure:
          - Virtual workspace manifest detected at root
          - Built package member: ${{ github.event.inputs.package_name }}
          
          ${{ steps.build_apk.outputs.build_success == 'true' && 'The APK is ready for installation on Android devices.' || format('Build output: {0}', steps.build_library.outputs.lib_success == 'true' && 'Native libraries (.so files) were built successfully, but APK generation failed.' || 'No build artifacts were produced.') }}
          
          ${{ steps.build_apk.outputs.build_success != 'true' && 'Troubleshooting:' || '' }}
          ${{ steps.build_apk.outputs.build_success != 'true' && '- Ensure the selected package has proper [package.metadata.android] configuration' || '' }}
          ${{ steps.build_apk.outputs.build_success != 'true' && '- Check that the package contains Android-specific code and resources' || '' }}
          ${{ steps.build_apk.outputs.build_success != 'true' && '- Verify all Android dependencies are correctly configured' || '' }}
          
          Note: This is an unofficial build. Use at your own risk.
          EOF
          
          echo "Build info created"
          cat output/build-info.txt
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phira-android-${{ github.event.inputs.package_name }}-${{ github.event.inputs.features }}-${{ github.event.inputs.build_mode }}-${{ github.run_number }}
          path: output/*
          retention-days: 30
          
      - name: Summary
        run: |
          echo "## ðŸ“± Phira Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package**: ${{ steps.project_check.outputs.package_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Features**: ${{ github.event.inputs.features }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Mode**: ${{ github.event.inputs.build_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: aarch64-linux-android" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build_apk.outputs.build_success }}" = "true" ]; then
            echo "âœ… **Build Status**: APK Successfully Created!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
            echo "Your Phira Android APK is available in the build artifacts." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Installation" >> $GITHUB_STEP_SUMMARY
            echo "1. Download \`phira-android.apk\` from artifacts" >> $GITHUB_STEP_SUMMARY
            echo "2. Enable \"Install from unknown sources\" on your Android device" >> $GITHUB_STEP_SUMMARY
            echo "3. Install and enjoy Phira with ${{ github.event.inputs.features }} features!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.build_library.outputs.lib_success }}" = "true" ]; then
            echo "âš ï¸ **Build Status**: Partial Success (Library Only)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“š What was built:" >> $GITHUB_STEP_SUMMARY
            echo "- Native Android libraries (\`.so\` files) were successfully compiled" >> $GITHUB_STEP_SUMMARY
            echo "- APK packaging failed (missing Android metadata or resources)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ To fix APK generation:" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure \`[package.metadata.android]\` section exists in package Cargo.toml" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Android resource files are present" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Status**: Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Possible causes:" >> $GITHUB_STEP_SUMMARY
            echo "- Incorrect workspace member selected" >> $GITHUB_STEP_SUMMARY
            echo "- Missing Android support in the codebase" >> $GITHUB_STEP_SUMMARY
            echo "- Compilation errors in the source code" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "- Check the detailed build logs above" >> $GITHUB_STEP_SUMMARY
            echo "- Verify the correct package name (try \`phira\` or \`phira-main\`)" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure all dependencies are compatible with Android" >> $GITHUB_STEP_SUMMARY
          fi
