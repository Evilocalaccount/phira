name: æž„å»º Phira Android åŽŸç”Ÿåº“ (æœ€ç»ˆä¿®å¤ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      features:
        description: 'å¯ç”¨åŠŸèƒ½'
        required: false
        default: 'chat'
        type: choice
        options:
          - chat
          - chat,video
          - chat,video,aa
          - chat,video,aa,event_debug

env:
  CARGO_TERM_COLOR: always
  ANDROID_HOME: ${{github.workspace}}/android-sdk
  ANDROID_NDK_HOME: ${{github.workspace}}/android-ndk-r27c
  ANDROID_NDK_ROOT: ${{github.workspace}}/android-ndk-r27c

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4.2.2

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libasound2-dev \
            libssl-dev \
            pkg-config \
            unzip \
            wget
          sed -i '1d' prpr/src/lib.rs

      - name: ä¸‹è½½é™æ€åº“
        uses: suisei-cn/actions-download-file@v1.3.0
        with:
          url: "https://teamflos.github.io/phira-docs/phira_build_guide/prpr-avc.zip"
          target: ./

      - name: è§£åŽ‹é™æ€åº“
        run: unzip -q prpr-avc.zip -d ./

      - name: å®‰è£… Android SDK
        run: |
          mkdir -p $ANDROID_HOME
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
          unzip -q commandlinetools-linux-8512546_latest.zip -d $ANDROID_HOME
          echo y | $ANDROID_HOME/cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} \
            "platform-tools" "build-tools;33.0.2" "platforms;android-35"

      - name: å®‰è£… Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r27c-linux.zip
          unzip -q android-ndk-r27c-linux.zip -d ${{github.workspace}}

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: actions-rs/toolchain@v1.0.6
        with:
          toolchain: stable
          target: aarch64-linux-android

      - name: å®‰è£… cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: æž„å»º Android åŽŸç”Ÿåº“ (ä¿®å¤ç‰ˆ)
        run: |
          cd phira
          # ä¿®å¤: cargo-ndk 4.x ç‰ˆæœ¬ä¸éœ€è¦ -p å‚æ•°
          # æ­£ç¡®çš„æ ¼å¼: cargo ndk -t arm64-v8a -p 35 build --release
          # ä½† -p åœ¨ 4.x ä¸­å·²å¼ƒç”¨ï¼Œæ”¹ç”¨ --platform æˆ–ç›´æŽ¥çœç•¥
          cargo ndk --target arm64-v8a --platform 35 -- build --release --features "${{ github.event.inputs.features }}"

      - name: æŸ¥æ‰¾å¹¶ä¿å­˜ .so æ–‡ä»¶
        run: |
          mkdir -p output
          SO_FILE=$(find target/aarch64-linux-android -name "libphira.so" -type f | head -1)
          if [ -n "$SO_FILE" ]; then
            cp "$SO_FILE" output/libphira.so
            echo "âœ… libphira.so å·²æ‰¾åˆ°å¹¶å¤åˆ¶: $SO_FILE"
            ls -lh output/libphira.so
          else
            echo "âŒ æœªæ‰¾åˆ° libphira.so"
            find target -name "*.so" -type f
          fi

      - name: åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
        run: |
          cat > output/ä½¿ç”¨è¯´æ˜Ž.md << 'EOF'
          # Phira Android æž„å»ºäº§ç‰©ä½¿ç”¨è¯´æ˜Ž
          
          ## æž„å»ºäº§ç‰©
          - **libphira.so**: Android åŽŸç”Ÿåº“æ–‡ä»¶
          
          ## ä½¿ç”¨æ–¹æ³• (äºŒé€‰ä¸€)
          
          ### æ–¹æ³•ä¸€: æ‰‹åŠ¨æ›¿æ¢ï¼ˆæŽ¨èï¼‰
          1. ä»Ž [Phira GitHub Releases](https://github.com/TeamFlos/phira/releases) ä¸‹è½½ç›¸åŒç‰ˆæœ¬çš„å®˜æ–¹ APK
          2. ä½¿ç”¨ **MTç®¡ç†å™¨** æˆ– **ApkTool** è§£åŽ‹å®˜æ–¹ APK
          3. è¿›å…¥ `lib/arm64-v8a/` ç›®å½•
          4. ç”¨æ­¤ `libphira.so` æ›¿æ¢åŽŸæœ‰çš„ `libphira.so`
          5. ç”¨ **Dexç¼–è¾‘å™¨++** æ‰“å¼€ `classes.dex`
          6. æ‰¾åˆ° `org/flos/phira/QuadSurface` ç±»ï¼Œå®šä½åˆ°ç¬¬153è¡Œ
          7. åˆ é™¤æˆ–æ³¨é‡ŠæŽ‰ `preprocessInput` ç›¸å…³çš„è°ƒç”¨
          8. ä¿å­˜ä¿®æ”¹ï¼Œé‡æ–°ç­¾å APK
          9. å®‰è£…åˆ°è®¾å¤‡
          
          ### æ–¹æ³•äºŒ: æ·»åŠ  JNI å‡½æ•°
          åœ¨ `phira/src/lib.rs` ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š
          ```rust
          #[cfg(target_os = "android")]
          #[no_mangle]
          pub unsafe extern "C" fn Java_quad_1native_QuadNative_preprocessInput(
              _: *mut std::ffi::c_void,
              _: *const std::ffi::c_void,
              motionEvent: ndk_sys::AInputEvent,
              f: ndk_sys::jfloat,
              f2: ndk_sys::jfloat,
              z: ndk_sys::jboolean,
              z2: ndk_sys::jboolean,
          ) {
              // è§¦æ‘¸äº‹ä»¶é¢„å¤„ç†å®žçŽ°
          }
          ```
          ç„¶åŽé‡æ–°è¿è¡Œæ­¤å·¥ä½œæµæž„å»º libphira.so
          
          **åŠŸèƒ½é…ç½®**: ${{ github.event.inputs.features }}
          **æž„å»ºæ—¶é—´**: $(date)
          EOF

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: phira-android-lib-${{ github.event.inputs.features }}-${{ github.run_number }}
          path: output/
          retention-days: 30

      - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸ“± Phira Android åŽŸç”Ÿåº“æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŠŸèƒ½é…ç½®**: ${{ github.event.inputs.features }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- **libphira.so**: åŽŸç”Ÿåº“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **ä½¿ç”¨è¯´æ˜Ž.md**: è¯¦ç»†æ›¿æ¢æ•™ç¨‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ Artifacts åŽ‹ç¼©åŒ…" >> $GITHUB_STEP_SUMMARY
          echo "2. æŒ‰ç…§ ä½¿ç”¨è¯´æ˜Ž.md æ›¿æ¢å®˜æ–¹ APK" >> $GITHUB_STEP_SUMMARY
          echo "3. ä¿®å¤ preprocessInput è°ƒç”¨" >> $GITHUB_STEP_SUMMARY
          echo "4. é‡æ–°ç­¾åå¹¶å®‰è£…åˆ°è®¾å¤‡" >> $GITHUB_STEP_SUMMARY
