name: Build Phira Android APK (v3)

on:
  workflow_dispatch:
    inputs:
      features:
        description: 'Features to enable'
        required: false
        default: 'chat'
        type: choice
        options:
          - chat
          - chat,video
          - chat,video,aa
          - chat,video,aa,event_debug
      build_mode:
        description: 'Build mode'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug
      target_package:
        description: 'Package to build (try phira first)'
        required: false
        default: 'phira'
        type: choice
        options:
          - phira
          - phira-main

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: TeamFlos/phira
          ref: main
          
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            **/target
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Setup Android environment
        run: |
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mkdir -p android-sdk/cmdline-tools
          mv cmdline-tools android-sdk/cmdline-tools/latest
          
          export ANDROID_HOME=$PWD/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          
          (yes || true) | sdkmanager --licenses
          sdkmanager --install "platforms;android-33" "build-tools;33.0.0" "ndk;25.2.9519653"
          
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          
      - name: Install cargo-apk
        run: cargo install cargo-apk --locked --force
          
      - name: Analyze and patch package
        id: analysis
        run: |
          PKG="${{ github.event.inputs.target_package }}"
          echo "Target: $PKG"
          
          if [ ! -f "$PKG/Cargo.toml" ]; then
            echo "Package not found!"
            exit 1
          fi
          
          cd $PKG
          
          # Extract package name
          PKG_NAME=$(grep '^name' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
          
          # Analyze crate type
          echo "=== Crate structure ==="
          ls -la src/
          
          HAS_LIB_RS=false
          HAS_MAIN_RS=false
          [ -f "src/lib.rs" ] && HAS_LIB_RS=true
          [ -f "src/main.rs" ] && HAS_MAIN_RS=true
          
          echo "has_lib_rs=$HAS_LIB_RS" >> $GITHUB_OUTPUT
          echo "has_main_rs=$HAS_MAIN_RS" >> $GITHUB_OUTPUT
          
          # Check Android metadata
          HAS_ANDROID=$(grep -q 'package.metadata.android' Cargo.toml && echo "true" || echo "false")
          echo "has_android=$HAS_ANDROID" >> $GITHUB_OUTPUT
          
          echo "Crate type: $([ "$HAS_LIB_RS" = true ] && echo 'LIBRARY' || echo 'BINARY')"
          
      - name: Add [lib] section for binary crates
        if: steps.analysis.outputs.has_lib_rs == 'false' && steps.analysis.outputs.has_main_rs == 'true'
        run: |
          echo "Creating src/lib.rs for binary crate..."
          cd ${{ github.event.inputs.target_package }}
          
          # Create minimal lib.rs that delegates to main
          cat > src/lib.rs << 'EOF'
          //! Android library entry point
          //! 
          //! This is a wrapper to allow building the binary as an Android library.
          //! The actual logic remains in src/main.rs.
          
          /// Android main entry point
          #[no_mangle]
          pub extern "C" fn android_main() {
              // For now, just a placeholder
              // In a real scenario, you'd extract the game loop logic into a library
              // and call it from both main.rs and here
          }
          EOF
          
          # Add [lib] to Cargo.toml WITHOUT conflicting with [bin]
          cat >> Cargo.toml << 'EOF'
          
          [lib]
          crate-type = ["cdylib"]
          name = "phira_android"
          path = "src/lib.rs"
          EOF
          
      - name: Add Android metadata
        if: steps.analysis.outputs.has_android == 'false'
        run: |
          cd ${{ github.event.inputs.target_package }}
          
          cat >> Cargo.toml << 'EOF'
          
          [package.metadata.android]
          package_name = "com.phira.game"
          version_code = 1
          # version_name is NOT specified here - cargo-apk sets it automatically
          
          [package.metadata.android.sdk]
          min_sdk_version = 21
          target_sdk_version = 33
          
          [package.metadata.android.activity]
          orientation = "landscape"
          config_changes = "orientation|keyboardHidden|screenSize"
          
          [[package.metadata.android.permission]]
          name = "android.permission.INTERNET"
          
          [[package.metadata.android.permission]]
          name = "android.permission.ACCESS_NETWORK_STATE"
          EOF
          
      - name: Configure cargo
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [build]
          target = "aarch64-linux-android"
          
          [target.aarch64-linux-android]
          ar = "${ANDROID_NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "${ANDROID_NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          
          [unstable]
          build-std = true
          EOF
          
      - name: Build APK
        id: build_apk
        run: |
          echo "Building package: ${{ steps.analysis.outputs.pkg_name }}"
          
          if cargo apk build \
            -p "${{ steps.analysis.outputs.pkg_name }}" \
            --features "${{ github.event.inputs.features }}" \
            --target aarch64-linux-android \
            --${{ github.event.inputs.build_mode }}; then
            
            echo "build_success=true" >> $GITHUB_OUTPUT
            
            APK=$(find . -path "*/android-artifacts/**/*.apk" -type f 2>/dev/null | head -1 || \
                  find . -name "*.apk" -type f 2>/dev/null | head -1 || echo "")
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Final fallback - Native library
        if: steps.build_apk.outputs.build_success != 'true'
        id: lib_build
        run: |
          echo "Building native library as final fallback..."
          
          if cargo build \
            -p "${{ steps.analysis.outputs.pkg_name }}" \
            --features "${{ github.event.inputs.features }}" \
            --target aarch64-linux-android \
            --${{ github.event.inputs.build_mode }}; then
            
            LIB=$(find target/aarch64-linux-android -name "*.so" -type f 2>/dev/null | head -1 || echo "")
            echo "lib_path=$LIB" >> $GITHUB_OUTPUT
            echo "lib_success=true" >> $GITHUB_OUTPUT
          else
            echo "lib_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Prepare artifacts
        run: |
          mkdir -p output
          
          if [ -f "${{ steps.build_apk.outputs.apk_path }}" ]; then
            cp "${{ steps.build_apk.outputs.apk_path }}" output/phira.apk
          elif [ -f "${{ steps.lib_build.outputs.lib_path }}" ]; then
            cp "${{ steps.lib_build.outputs.lib_path }}" output/libphira.so
          fi
          
          cat > output/build-info.txt << EOF
          Phira Android Build
          ==================
          Package: ${{ steps.analysis.outputs.pkg_name }}
          Features: ${{ github.event.inputs.features }}
          Mode: ${{ github.event.inputs.build_mode }}
          
          Status:
          - APK: ${{ steps.build_apk.outputs.build_success == 'true' && '✅ SUCCESS' || '❌ FAILED' }}
          - Library: ${{ steps.lib_build.outputs.lib_success == 'true' && '✅ SUCCESS' || '❌ FAILED' }}
          
          Note: This is an unofficial build.
          EOF
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phira-android-${{ github.event.inputs.target_package }}-${{ github.event.inputs.features }}-${{ github.event.inputs.build_mode }}
          path: output/
          retention-days: 30
