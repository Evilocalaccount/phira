name: æž„å»º Phira Android åŽŸç”Ÿåº“

on:
  workflow_dispatch:
    inputs:
      features:
        description: 'å¯ç”¨åŠŸèƒ½'
        required: false
        default: 'chat'
        type: choice
        options:
          - chat
          - chat,video
          - chat,video,aa
          - chat,video,aa,event_debug

env:
  CARGO_TERM_COLOR: always
  ANDROID_HOME: ${{github.workspace}}/android-sdk
  ANDROID_NDK_HOME: ${{github.workspace}}/android-ndk-r27c
  ANDROID_NDK_ROOT: ${{github.workspace}}/android-ndk-r27c

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4.2.2

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev librsvg2-dev libasound2-dev libssl-dev pkg-config

      - name: ä¿®å¤ prpr åº“ä»£ç 
        run: |
          # åˆ é™¤ç¬¬ä¸€è¡Œ
          sed -i '1d' prpr/src/lib.rs

      - name: ä¸‹è½½é™æ€åº“
        uses: suisei-cn/actions-download-file@v1.3.0
        with:
          url: "https://teamflos.github.io/phira-docs/phira_build_guide/prpr-avc.zip"
          target: ./

      - name: è§£åŽ‹é™æ€åº“
        run: unzip prpr-avc.zip -d ./

      - name: å®‰è£… Android SDK
        run: |
          mkdir -p $ANDROID_HOME
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
          unzip -q commandlinetools-linux-8512546_latest.zip -d $ANDROID_HOME
          echo y | $ANDROID_HOME/cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} "platform-tools" "build-tools;33.0.2" "platforms;android-35"

      - name: å®‰è£… Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r27c-linux.zip
          unzip -q android-ndk-r27c-linux.zip -d ${{github.workspace}}

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: actions-rs/toolchain@v1.0.6
        with:
          toolchain: stable
          target: aarch64-linux-android

      - name: æž„å»º Android åŽŸç”Ÿåº“
        run: |
          cargo install cargo-ndk
          cd phira
          cargo ndk -t arm64-v8a -p 35 build --release --features "${{ github.event.inputs.features }}"

      - name: æŸ¥æ‰¾æž„å»ºäº§ç‰©
        id: find_so
        run: |
          SO_FILE=$(find target -name "libphira.so" -type f | head -1)
          echo "so_path=$SO_FILE" >> $GITHUB_OUTPUT
          echo "æž„å»ºçš„åº“æ–‡ä»¶: $SO_FILE"

      - name: ä¸‹è½½å®˜æ–¹ APK æ¨¡æ¿
        run: |
          # ä»Žå®˜æ–¹ release ä¸‹è½½å¯¹åº”æž¶æž„çš„ APK
          # è¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºå®žé™…çš„ä¸‹è½½é“¾æŽ¥
          wget -q "https://github.com/TeamFlos/phira/releases/download/v0.6.7/phira-arm64-v8a-release.apk" -O template.apk || \
          echo "âš ï¸ éœ€è¦æ‰‹åŠ¨ä¸‹è½½å®˜æ–¹ APK å¹¶ä¸Šä¼ "

      - name: å‡†å¤‡æž„å»ºäº§ç‰©
        run: |
          mkdir -p output
          
          # å¤åˆ¶ .so æ–‡ä»¶
          if [ -f "${{ steps.find_so.outputs.so_path }}" ]; then
            cp "${{ steps.find_so.outputs.so_path }}" output/libphira.so
          fi
          
          # å¤åˆ¶æ¨¡æ¿ APK
          if [ -f "template.apk" ]; then
            cp template.apk output/phira-template.apk
          fi
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
          cat > output/ä½¿ç”¨è¯´æ˜Ž.txt << 'EOF'
          Phira Android æž„å»ºäº§ç‰©ä½¿ç”¨è¯´æ˜Ž
          ============================
          
          ä½ æž„å»ºçš„æ–‡ä»¶:
          1. libphira.so - Android åŽŸç”Ÿåº“æ–‡ä»¶
          2. phira-template.apk - å®˜æ–¹ APK æ¨¡æ¿
          
          ä½¿ç”¨æ–¹æ³• (äºŒé€‰ä¸€):
          
          ã€æ–¹æ³•ä¸€ã€‘æ‰‹åŠ¨æ›¿æ¢
          1. ç”¨ MTç®¡ç†å™¨/ApkTool æ‰“å¼€å®˜æ–¹ APK
          2. è¿›å…¥ lib/arm64-v8a/ ç›®å½•
          3. ç”¨æ­¤ libphira.so æ›¿æ¢åŽŸæœ‰çš„ libphira.so
          4. æ‰¾åˆ°å¹¶æ³¨é‡ŠæŽ‰ QuadSurface ç±»ä¸­çš„ preprocessInput è°ƒç”¨
          5. é‡æ–°ç­¾å APK å¹¶å®‰è£…
          
          ã€æ–¹æ³•äºŒã€‘ä¿®å¤ä»£ç 
          1. åœ¨ phira/src/lib.rs ä¸­æ·»åŠ :
          
             #[cfg(target_os = "android")]
             #[no_mangle]
             pub unsafe extern "C" fn Java_quad_1native_QuadNative_preprocessInput(
                 _: *mut std::ffi::c_void,
                 _: *const std::ffi::c_void,
                 motionEvent: ndk_sys::AInputEvent,
                 f: ndk_sys::jfloat,
                 f2: ndk_sys::jfloat,
                 z: ndk_sys::jboolean,
                 z2: ndk_sys::jboolean,
             ) {
                 // å®žçŽ°è§¦æ‘¸é¢„å¤„ç†
             }
          
          2. é‡æ–°æž„å»º libphira.so
          3. æ›¿æ¢ APK ä¸­çš„åº“æ–‡ä»¶
          
          åŠŸèƒ½é…ç½®: ${{ github.event.inputs.features }}
          æž„å»ºæ—¶é—´: $(date)
          EOF

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: phira-android-lib-${{ github.event.inputs.features }}-${{ github.run_number }}
          path: output/
          retention-days: 30

      - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸ“± Phira Android æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŠŸèƒ½é…ç½®**: ${{ github.event.inputs.features }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- **libphira.so**: Android åŽŸç”Ÿåº“" >> $GITHUB_STEP_SUMMARY
          echo "- **phira-template.apk**: å®˜æ–¹ APK æ¨¡æ¿" >> $GITHUB_STEP_SUMMARY
          echo "- **ä½¿ç”¨è¯´æ˜Ž.txt**: æ›¿æ¢æ•™ç¨‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½æž„å»ºäº§ç‰©åŽ‹ç¼©åŒ…" >> $GITHUB_STEP_SUMMARY
          echo "2. æŒ‰ç…§ ä½¿ç”¨è¯´æ˜Ž.txt æ›¿æ¢ APK ä¸­çš„åº“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "3. é‡æ–°ç­¾åå¹¶å®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **æ³¨æ„**: éœ€è¦æ‰‹åŠ¨å¤„ç† preprocessInput çš„è°ƒç”¨æˆ–å®žçŽ°" >> $GITHUB_STEP_SUMMARY
