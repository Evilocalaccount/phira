name: æž„å»º Phira Android åŽŸç”Ÿåº“ (ä¿®æ­£ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      features:
        description: 'å¯ç”¨åŠŸèƒ½'
        required: false
        default: 'chat'
        type: choice
        options:
          - chat
          - chat,video
          - chat,video,aa
          - chat,video,aa,event_debug

env:
  CARGO_TERM_COLOR: always
  ANDROID_HOME: ${{github.workspace}}/android-sdk
  ANDROID_NDK_HOME: ${{github.workspace}}/android-ndk-r27c
  ANDROID_NDK_ROOT: ${{github.workspace}}/android-ndk-r27c

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4.2.2

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          
          # ä¿®å¤: ä½¿ç”¨ libwebkit2gtk-4.1-dev æ›¿ä»£ 4.0-dev (Ubuntu 24.04+)
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libasound2-dev \
            libssl-dev \
            pkg-config \
            unzip \
            wget
          
          # å®˜æ–¹æ­¥éª¤: åˆ é™¤ prpr/src/lib.rs ç¬¬ä¸€è¡Œ
          sed -i '1d' prpr/src/lib.rs

      - name: ä¸‹è½½é™æ€åº“
        uses: suisei-cn/actions-download-file@v1.3.0
        with:
          url: "https://teamflos.github.io/phira-docs/phira_build_guide/prpr-avc.zip"
          target: ./

      - name: è§£åŽ‹é™æ€åº“
        run: unzip prpr-avc.zip -d ./

      - name: å®‰è£… Android SDK
        run: |
          mkdir -p $ANDROID_HOME
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
          unzip -q commandlinetools-linux-8512546_latest.zip -d $ANDROID_HOME
          echo y | $ANDROID_HOME/cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} \
            "platform-tools" "build-tools;33.0.2" "platforms;android-35"

      - name: å®‰è£… Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r27c-linux.zip
          unzip -q android-ndk-r27c-linux.zip -d ${{github.workspace}}

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: actions-rs/toolchain@v1.0.6
        with:
          toolchain: stable
          target: aarch64-linux-android

      - name: æž„å»º Android åŽŸç”Ÿåº“
        run: |
          cd phira
          cargo install cargo-ndk
          cargo ndk -t arm64-v8a -p 35 build --release --features "${{ github.event.inputs.features }}"

      - name: å‡†å¤‡æž„å»ºäº§ç‰©
        run: |
          mkdir -p output
          SO_FILE=$(find target -name "libphira.so" -type f | head -1)
          if [ -n "$SO_FILE" ]; then
            cp "$SO_FILE" output/libphira.so
            echo "âœ… libphira.so å·²å¤åˆ¶åˆ° output/"
          fi

      - name: åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
        run: |
          cat > output/ä½¿ç”¨è¯´æ˜Ž.md << 'EOF'
          # Phira Android æž„å»ºäº§ç‰©ä½¿ç”¨è¯´æ˜Ž
          
          ## æž„å»ºäº§ç‰©
          - **libphira.so**: Android åŽŸç”Ÿåº“æ–‡ä»¶
          
          ## ä½¿ç”¨æ–¹æ³• (äºŒé€‰ä¸€)
          
          ### æ–¹æ³•ä¸€: æ‰‹åŠ¨æ›¿æ¢
          1. ä»Žå®˜æ–¹ Release ä¸‹è½½å¯¹åº”æž¶æž„çš„ APK
          2. ä½¿ç”¨ MTç®¡ç†å™¨/ApkTool è§£åŽ‹ APK
          3. æ›¿æ¢ `lib/arm64-v8a/libphira.so`
          4. ç”¨ Dexç¼–è¾‘å™¨++ æ‰“å¼€ `classes.dex`
          5. æ‰¾åˆ° `QuadSurface` ç±»ï¼Œæ³¨é‡Š/åˆ é™¤ `preprocessInput` è°ƒç”¨
          6. é‡æ–°ç­¾åå¹¶å®‰è£…
          
          ### æ–¹æ³•äºŒ: æ·»åŠ  JNI å‡½æ•°
          åœ¨ `phira/src/lib.rs` æ·»åŠ :
          ```rust
          #[cfg(target_os = "android")]
          #[no_mangle]
          pub unsafe extern "C" fn Java_quad_1native_QuadNative_preprocessInput(
              _: *mut std::ffi::c_void,
              _: *const std::ffi::c_void,
              motionEvent: ndk_sys::AInputEvent,
              f: ndk_sys::jfloat,
              f2: ndk_sys::jfloat,
              z: ndk_sys::jboolean,
              z2: ndk_sys::jboolean,
          ) {}
          ```
          ç„¶åŽé‡æ–°æž„å»º libphira.so
          
          **åŠŸèƒ½é…ç½®**: ${{ github.event.inputs.features }}
          **æž„å»ºæ—¶é—´**: $(date)
          EOF

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: phira-android-lib-${{ github.event.inputs.features }}-${{ github.run_number }}
          path: output/
          retention-days: 30

      - name: ç”Ÿæˆæ‘˜è¦
        run: |
          echo "## ðŸ“± Phira Android åŽŸç”Ÿåº“æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŠŸèƒ½é…ç½®**: ${{ github.event.inputs.features }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- **libphira.so**: åŽŸç”Ÿåº“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **ä½¿ç”¨è¯´æ˜Ž.md**: è¯¦ç»†æ›¿æ¢æ•™ç¨‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ Artifacts åŽ‹ç¼©åŒ…" >> $GITHUB_STEP_SUMMARY
          echo "2. æŒ‰ç…§ ä½¿ç”¨è¯´æ˜Ž.md æ›¿æ¢å®˜æ–¹ APK" >> $GITHUB_STEP_SUMMARY
          echo "3. ä¿®å¤ preprocessInput é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "4. é‡æ–°ç­¾åå®‰è£…" >> $GITHUB_STEP_SUMMARY
